<style>
    .ad-form-card {
        background: var(--glass);
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 20px;
        margin: 20px auto;
        width: 90%;
        max-width: 500px;
    }
    .ad-input {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: white;
        font-family: 'Cairo';
    }
    .ads-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        width: 90%;
        margin-top: 40px;
    }
    .ad-card {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 15px;
        overflow: hidden;
        transition: 0.3s;
    }
    .ad-card img { width: 100%; height: 200px; object-fit: cover; }
    .ad-card-body { padding: 15px; text-align: right; }
    
    /* ستايل الدردشة البسيط */
    #chat-box {
        position: fixed; bottom: 20px; left: 20px; width: 300px; height: 400px;
        background: #0a0e14; border: 1px solid var(--gold); border-radius: 15px;
        display: none; flex-direction: column; z-index: 1000;
    }
</style>

<div id="ads-section" style="display:none; width: 100%;">
    <div class="ad-form-card">
        <h3 style="color: var(--gold)">أعلن عن منتجك الفاخر</h3>
        <input type="text" id="adTitle" placeholder="عنوان الإعلان" class="ad-input">
        <textarea id="adDesc" placeholder="وصف الإعلان" class="ad-input" rows="3"></textarea>
        <input type="file" id="adImage" class="ad-input" accept="image/*">
        <button id="postAdBtn" class="auth-btn">نشر الإعلان الآن</button>
    </div>

    <h2 style="color: var(--gold); margin-top: 50px;">الإعلانات الحالية</h2>
    <div id="adsList" class="ads-container">
        </div>
</div>

<div id="chat-box">
    <div style="padding:10px; background:var(--gold); color:black; font-weight:bold; border-radius:15px 15px 0 0; display:flex; justify-content:space-between;">
        <span>الدردشة</span>
        <button onclick="document.getElementById('chat-box').style.display='none'" style="border:none; background:none; cursor:pointer">✕</button>
    </div>
    <div id="messages" style="flex:1; overflow-y:auto; padding:10px; font-size:14px;"></div>
    <div style="padding:10px; display:flex; gap:5px;">
        <input type="text" id="msgInput" style="flex:1; border-radius:5px; border:1px solid #333; padding:5px;">
        <button id="sendMsgBtn" style="background:var(--gold); border:none; padding:5px 10px; border-radius:5px;">ارسل</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAj9-v2keOetxOTi9Bb9GbiGhJeSH5Wcgs",
        authDomain: "gastssa.firebaseapp.com",
        projectId: "gastssa",
        storageBucket: "gastssa.firebasestorage.app",
        messagingSenderId: "80656562183",
        appId: "1:80656562183:web:8c99a7f175c3e31f9b92a2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById("ads-section").style.display = "block";
            loadAds();
        } else {
            document.getElementById("ads-section").style.display = "none";
        }
    });

    // وظيفة رفع الإعلان
    document.getElementById("postAdBtn").onclick = async () => {
        const title = document.getElementById("adTitle").value;
        const desc = document.getElementById("adDesc").value;
        const file = document.getElementById("adImage").files[0];

        if (!title || !file) return alert("يرجى ملء البيانات واختيار صورة");

        try {
            // 1. رفع الصورة إلى Storage
            const storageRef = ref(storage, 'ads/' + Date.now() + "_" + file.name);
            const snapshot = await uploadBytes(storageRef, file);
            const url = await getDownloadURL(snapshot.ref);

            // 2. حفظ البيانات في Firestore
            await addDoc(collection(db, "ads"), {
                title,
                desc,
                imageUrl: url,
                userId: currentUser.uid,
                userName: currentUser.displayName,
                createdAt: serverTimestamp()
            });

            alert("تم نشر إعلانك بنجاح!");
            location.reload();
        } catch (e) { console.error(e); }
    };

    // وظيفة تحميل الإعلانات
    function loadAds() {
        const q = query(collection(db, "ads"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const adsList = document.getElementById("adsList");
            adsList.innerHTML = "";
            snapshot.forEach((doc) => {
                const ad = doc.data();
                adsList.innerHTML += `
                    <div class="ad-card">
                        <img src="${ad.imageUrl}">
                        <div class="ad-card-body">
                            <h4 style="color:var(--gold); margin:0">${ad.title}</h4>
                            <p style="font-size:13px; opacity:0.8">${ad.desc}</p>
                            <button onclick="openChat('${ad.userId}')" class="auth-btn" style="padding:5px 15px; font-size:12px">تواصل مع المعلن</button>
                        </div>
                    </div>
                `;
            });
        });
    }

    // وظيفة الدردشة البسيطة (تحتاج لإعداد إضافي في Firestore للرسائل)
    window.openChat = (sellerId) => {
        document.getElementById('chat-box').style.display = 'flex';
        // منطق جلب الرسائل بين currentUser.uid و sellerId يوضع هنا
    };
</script>
