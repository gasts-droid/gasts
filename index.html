<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>شركة GASTS | فخامة الإعلان</title>
<!-- روابط الخطوط والستايل هنا (نفس الكود السابق) -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet" />
<style>
  /* (نفس ستايل الصفحة السابق، أو يمكنك نسخه هنا) */
  /*... (أبقي على نفس ستايل الصفحة من الكود السابق) ...*/
</style>
</head>
<body>
<!-- محتوى الصفحة السابق مع إضافة عناصر التحكم -->

<!-- أزرار تسجيل الدخول والتسجيل -->
<div id="auth-buttons" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
  <button id="login-btn">تسجيل الدخول</button>
  <button id="signup-btn">إنشاء حساب</button>
  <button id="logout-btn" style="display:none;">تسجيل الخروج</button>
</div>

<!-- نوافذ نماذج التسجيل/تسجيل الدخول -->
<div id="auth-forms" style="display:none; position: fixed; top: 70px; right: 20px; background:#fff; padding:20px; border-radius:10px; z-index:1000;">
  <div id="signup-form" style="display:none;">
    <h3>إنشاء حساب</h3>
    <input type="text" id="signup-name" placeholder="الاسم" />
    <input type="email" id="signup-email" placeholder="البريد الإلكتروني" />
    <input type="password" id="signup-password" placeholder="كلمة المرور" />
    <button id="signup-submit">تسجيل</button>
    <button id="close-signup">إغلاق</button>
  </div>
  <div id="login-form">
    <h3>تسجيل الدخول</h3>
    <input type="email" id="login-email" placeholder="البريد الإلكتروني" />
    <input type="password" id="login-password" placeholder="كلمة المرور" />
    <button id="login-submit">دخول</button>
    <button id="close-login">إغلاق</button>
  </div>
</div>

<!-- قسم إدارة الملف الشخصي -->
<div id="profile-section" style="display:none; position:fixed; top:150px; right:20px; background:#fff; padding:20px; border-radius:10px; max-width:300px; z-index:1000;">
  <h3>ملفي الشخصي</h3>
  <div>
    <label>الاسم:</label>
    <input type="text" id="profile-name" />
  </div>
  <div>
    <label>الصورة:</label>
    <input type="file" id="profile-image" />
  </div>
  <button onclick="updateProfile()">حفظ التعديلات</button>
</div>

<!-- قسم نشر إعلان -->
<div id="ads-section" style="display:none; position:fixed; top:350px; right:20px; background:#fff; padding:20px; border-radius:10px; max-width:400px; z-index:1000;">
  <h3>نشر إعلان جديد</h3>
  <input type="text" id="ad-title" placeholder="عنوان الإعلان" style="width:100%; margin-bottom:10px;" />
  <textarea id="ad-desc" placeholder="وصف الإعلان" style="width:100%; height:80px; margin-bottom:10px;"></textarea>
  <input type="file" id="ad-image" />
  <button onclick="publishAd()">نشر الإعلان</button>
</div>

<!-- عرض الإعلانات مع خيارات التعديل والحذف -->
<div id="my-ads" style="margin-top:600px; padding:20px; max-width:800px; margin-left:auto; margin-right:auto;">
  <h2>إعلاناتي</h2>
  <div id="ads-list"></div>
</div>

<!-- باقي الصفحة (الهوية، الفوتر، الخ) كما هو من الكود السابق -->

<!-- سكربتات جافاسكريبت -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script>
  // إعداد الاتصال
  const supabaseUrl = 'https://hdyqcgsrjnciamsyeyla.supabase.co';
  const supabaseKey = 'sb_publishable_tlwDSDSqkIpBdKGe_oA4Gg_twuI4nJC';
  const supabase = createClient(supabaseUrl, supabaseKey);

  let currentUser = null;

  // أحداث الأزرار
document.getElementById('login-btn').onclick = () => {
  document.getElementById('auth-forms').style.display='block';
  document.getElementById('signup-form').style.display='none';
  document.getElementById('login-form').style.display='block';
};
document.getElementById('signup-btn').onclick = () => {
  document.getElementById('auth-forms').style.display='block';
  document.getElementById('signup-form').style.display='block';
  document.getElementById('login-form').style.display='none';
};
document.getElementById('close-signup').onclick = () => {
  document.getElementById('auth-forms').style.display='none';
};
document.getElementById('close-login').onclick = () => {
  document.getElementById('auth-forms').style.display='none';
};
document.getElementById('logout-btn').onclick = () => {
  supabase.auth.signOut();
  currentUser = null;
  updateUI();
};

// تسجيل حساب
document.getElementById('signup-submit').onclick = async () => {
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;
  const name = document.getElementById('signup-name').value;
  const { user, error } = await supabase.auth.signUp({ email, password });
  if (error) { alert('خطأ: ' + error.message); return; }

  // حفظ البيانات في جدول profiles
  await supabase
    .from('profiles')
    .insert([{ id: user.id, name: name }]);

  alert('تم التسجيل بنجاح! سجل الدخول الآن.');
  document.getElementById('auth-forms').style.display='none';
  loadUser();
};

// تسجيل دخول
document.getElementById('login-submit').onclick = async () => {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const { user, error } = await supabase.auth.signIn({ email, password });
  if (error) { alert('خطأ: ' + error.message); return; }
  loadUser();
  document.getElementById('auth-forms').style.display='none';
};

// تحميل المستخدم بعد تسجيل الدخول
async function loadUser() {
  const user = supabase.auth.user();
  if (!user) return;
  currentUser = user;
  updateUI();
  await loadProfile();
  await loadMyAds();
}

// تحديث واجهة المستخدم
function updateUI() {
  if (currentUser) {
    document.getElementById('auth-buttons').style.display='none';
    document.getElementById('logout-btn').style.display='inline-block';
    document.getElementById('profile-section').style.display='block';
    document.getElementById('ads-section').style.display='block';
  } else {
    document.getElementById('auth-buttons').style.display='block';
    document.getElementById('logout-btn').style.display='none';
    document.getElementById('profile-section').style.display='none';
    document.getElementById('ads-section').style.display='none';
  }
}

// تحديث الملف الشخصي
async function updateProfile() {
  if (!currentUser) return;
  const name = document.getElementById('profile-name').value;
  const imageFile = document.getElementById('profile-image').files[0];

  let imageUrl = null;
  if (imageFile) {
    const { data, error } = await supabase.storage
      .from('images')
      .upload(`profiles/${currentUser.id}/${imageFile.name}`, imageFile);
    if (error) { alert('خطأ في رفع الصورة: ' + error.message); return; }
    imageUrl = data.Key;
  }

  await supabase
    .from('profiles')
    .upsert({ id: currentUser.id, name: name, avatar_url: imageUrl });
  alert('تم تحديث الملف الشخصي');
  await loadProfile();
}

// تحميل البيانات الشخصية
async function loadProfile() {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();
  if (data) {
    document.getElementById('profile-name').value = data.name || '';
    // عرض الصورة إذا كانت موجودة
    // يمكن إضافة عنصر <img> لعرض الصورة
  }
}

// نشر إعلان جديد
async function publishAd() {
  const title = document.getElementById('ad-title').value;
  const desc = document.getElementById('ad-desc').value;
  const imageFile = document.getElementById('ad-image').files[0];

  if (!title || !desc || !imageFile) {
    alert('املأ جميع الحقول وارفع الصورة');
    return;
  }

  // رفع الصورة
  const { data, error } = await supabase.storage
    .from('images')
    .upload(`ads/${currentUser.id}/${imageFile.name}`, imageFile);
  if (error) { alert('خطأ في رفع الصورة: ' + error.message); return; }
  const imageUrl = data.Key;

  // إدخال الإعلان في قاعدة البيانات
  await supabase
    .from('ads')
    .insert([{
      user_id: currentUser.id,
      title: title,
      description: desc,
      image_url: imageUrl,
      created_at: new Date()
    }]);

  alert('تم نشر الإعلان');
  document.getElementById('ad-title').value = '';
  document.getElementById('ad-desc').value = '';
  document.getElementById('ad-image').value = '';
  await loadMyAds();
}

// تحميل إعلانات المستخدم
async function loadMyAds() {
  const { data, error } = await supabase
    .from('ads')
    .select('*')
    .eq('user_id', currentUser.id);
  const container = document.getElementById('ads-list');
  container.innerHTML = '';

  if (error || !data) return;

  data.forEach(ad => {
    const adDiv = document.createElement('div');
    adDiv.style.border='1px solid #ccc'; adDiv.style.padding='10px'; adDiv.style.marginBottom='10px';

    adDiv.innerHTML = `
      <h4>${ad.title}</h4>
      <img src="${supabase.storage.from('images').getPublicUrl(ad.image_url).publicURL}" style="width:100px; height:auto;"/>
      <p>${ad.description}</p>
      <button onclick="deleteAd('${ad.id}')">حذف</button>
      <button onclick="showEditAd('${ad.id}', '${ad.title}', '${ad.description}', '${ad.image_url}')">تعديل</button>
    `;
    container.appendChild(adDiv);
  });
}

// حذف إعلان
async function deleteAd(adId) {
  await supabase.from('ads').delete().eq('id', adId);
  await loadMyAds();
}

// إظهار نموذج تعديل الإعلان
function showEditAd(id, title, desc, imageUrl) {
  const newTitle = prompt('تعديل العنوان', title);
  const newDesc = prompt('تعديل الوصف', desc);
  // رفع صورة جديدة إذا رغبت
  // هنا يمكن تطوير واجهة أكثر تعقيداً
  if (newTitle && newDesc) {
    // تحديث الإعلان
    supabase
      .from('ads')
      .update({ title: newTitle, description: newDesc })
      .eq('id', id)
      .then(() => loadMyAds());
  }
}

// عند تحميل الصفحة، حاول تسجيل الدخول تلقائياً وإنشاء واجهة مناسبة
window.onload = () => {
  const user = supabase.auth.user();
  if (user) {
    currentUser = user;
    loadUser();
  } else {
    updateUI();
  }
};
</script>
</body>
</html>
