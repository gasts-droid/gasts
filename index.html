<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>موقع الإعلانات</title>
<!-- الخطوط -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Cairo', sans-serif; margin: 0; background-color: #111; color: #fff;
  }
  /* نماذج وتنسيقات عامة */
  /* ... يمكنك إضافة أنماط مخصصة هنا حسب رغبتك ... */
  /* تنسيق الواجهة */
  #navbar {
    display: flex; justify-content: space-between; padding: 10px 20px; background: rgba(0,0,0,0.4);
  }
  #navbar button { background: none; border: 1px solid #fff; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
  #navbar button:hover { background: #fff; color: #111; }

  /* منطقتك للملف الشخصي و الإعلانات */
  #profile, #ads, #chat, #filter-section { display: none; padding: 20px; }
  #profile input, #ad-form input, #ad-form select, #chat-input { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: none; }
  #ad-list, #messages { margin-top: 20px; }
  .ad-item, .message { border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #222; }
  /* تصنيفات */
  #category-select { width: 100%; padding: 8px; margin-bottom: 10px; }
</style>
</head>
<body>

<div id="navbar">
  <div>
    <button onclick="showSection('login')">تسجيل الدخول</button>
    <button onclick="showSection('register')">إنشاء حساب</button>
    <button onclick="logout()" id="logoutBtn" style="display:none;">تسجيل الخروج</button>
  </div>
  <div>
    <button onclick="showSection('profile')">ملفي الشخصي</button>
    <button onclick="showSection('ads')">إعلاناتي</button>
    <button onclick="showSection('chat')">الدردشة</button>
  </div>
</div>

<!-- أقسام الموقع -->

<!-- تسجيل الدخول -->
<div id="login" style="display:none; padding:20px;">
  <h2>تسجيل الدخول</h2>
  <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" />
  <input type="password" id="loginPassword" placeholder="كلمة المرور" />
  <button onclick="loginUser()">دخول</button>
</div>

<!-- إنشاء حساب -->
<div id="register" style="display:none; padding:20px;">
  <h2>إنشاء حساب</h2>
  <input type="text" id="regName" placeholder="اسم المستخدم" />
  <input type="email" id="regEmail" placeholder="البريد الإلكتروني" />
  <input type="password" id="regPassword" placeholder="كلمة المرور" />
  <button onclick="registerUser()">تسجيل</button>
</div>

<!-- الملف الشخصي -->
<div id="profile" style="display:none;">
  <h2>ملفي الشخصي</h2>
  <input type="text" id="profileName" placeholder="اسم المستخدم" />
  <input type="file" id="profileAvatar" />
  <button onclick="updateProfile()">حفظ التعديلات</button>
</div>

<!-- الإعلانات -->
<div id="ads">
  <h2>إعلاناتي</h2>
  <div>
    <select id="categoryFilter" onchange="filterAds()">
      <option value="">كل التصنيفات</option>
      <option value="سيارات">سيارات</option>
      <option value="عقارات">عقارات</option>
      <option value="أجهزة">أجهزة</option>
      <option value="أثاث">أثاث</option>
      <option value="أراضي">أراضي</option>
    </select>
  </div>
  <button onclick="showAdForm()">نشر إعلان جديد</button>
  <div id="ad-list"></div>
</div>

<!-- نموذج نشر إعلان -->
<div id="adFormContainer" style="display:none; padding:20px; background:#222; border-radius:10px; margin:20px 0;">
  <h3>نشر إعلان</h3>
  <input type="text" id="adTitle" placeholder="عنوان الإعلان" />
  <textarea id="adDesc" placeholder="وصف الإعلان"></textarea>
  <select id="adCategory">
    <option value="سيارات">سيارات</option>
    <option value="عقارات">عقارات</option>
    <option value="أجهزة">أجهزة</option>
    <option value="أثاث">أثاث</option>
    <option value="أراضي">أراضي</option>
  </select>
  <input type="file" id="adImage" />
  <button onclick="saveAd()">حفظ</button>
  <button onclick="hideAdForm()">إلغاء</button>
</div>

<!-- الدردشة -->
<div id="chat">
  <h2>الدردشة</h2>
  <div id="messages" style="height:300px; overflow-y:auto; background:#111; padding:10px; border-radius:10px;"></div>
  <input type="text" id="chatInput" placeholder="اكتب رسالتك..." />
  <button onclick="sendMessage()">إرسال</button>
</div>

<!-- استدعاء مكتبة Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<script>
  // إعداد الاتصال
  const supabaseUrl = 'https://hdyqcgsrjnciamsyeyla.supabase.co';
  const supabaseKey = 'sb_publishable_tlwDSDSqkIpBdKGe_oA4Gg_twuI4nJC';
  const supabase = createClient(supabaseUrl, supabaseKey);
  let currentUser = null;

  // عرض الأقسام
function showSection(section) {
  document.querySelectorAll('div[id]').forEach(div => {
    if (div.id === section) div.style.display='block';
    else div.style.display='none';
  });
  if (section === 'login' || section === 'register') return;
  // عند الانتقال لقسم آخر، تحديث الحالة
  if (section === 'profile' || section === 'ads') loadUserData();
  if (section === 'chat') loadMessages();
}

async function loadUserData() {
  if (!currentUser) return;
  // تحميل البيانات الشخصية
  const { data } = await supabase
    .from('profiles')
    .select('name, avatar_url')
    .eq('id', currentUser.id)
    .single();
  if (data) {
    document.getElementById('profileName').value = data.name || '';
    // يمكنك إضافة عرض الصورة هنا
  }
  loadUserAds();
}

// تسجيل الدخول
async function loginUser() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const { user, error } = await supabase.auth.signIn({ email, password });
  if (error) { alert(error.message); return; }
  currentUser = user;
  showSection('profile');
  showSection('ads');
  loadUserData();
  document.querySelector('#navbar').style.background='rgba(0,0,0,0.4)';
  document.querySelector('#logoutBtn').style.display='inline-block';
}

// تسجيل حساب
async function registerUser() {
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  const password = document.getElementById('regPassword').value;
  const { user, error } = await supabase.auth.signUp({ email, password });
  if (error) { alert(error.message); return; }
  await supabase.from('profiles').insert([{ id: user.id, name }]);
  alert('تم التسجيل بنجاح، سجل الدخول.');
  showSection('login');
}

// تسجيل الخروج
async function logout() {
  await supabase.auth.signOut();
  currentUser = null;
  showSection('login');
  document.querySelector('#logoutBtn').style.display='none';
}

// تحميل البيانات عند دخول المستخدم
supabase.auth.onAuthStateChange(async (event, session) => {
  if (session && session.user) {
    currentUser = session.user;
    showSection('profile');
    showSection('ads');
    loadUserData();
  }
});

// تحديث الملف الشخصي
async function updateProfile() {
  const name = document.getElementById('profileName').value;
  const avatarFile = document.getElementById('profileAvatar').files[0];
  let avatarUrl = null;
  if (avatarFile) {
    const { data, error } = await supabase.storage
      .from('images')
      .upload(`profiles/${currentUser.id}/${avatarFile.name}`, avatarFile);
    if (error) { alert(error.message); return; }
    avatarUrl = data.Key;
  }
  await supabase.from('profiles').upsert({ id: currentUser.id, name, avatar_url: avatarUrl });
  alert('تم تحديث الملف');
  loadUserData();
}

// عرض نموذج نشر إعلان
function showAdForm() {
  document.getElementById('adFormContainer').style.display='block';
}
function hideAdForm() {
  document.getElementById('adFormContainer').style.display='none';
}

// حفظ الإعلان
async function saveAd() {
  const title = document.getElementById('adTitle').value;
  const desc = document.getElementById('adDesc').value;
  const category = document.getElementById('adCategory').value;
  const imageFile = document.getElementById('adImage').files[0];
  if (!title || !desc || !imageFile) { alert('املأ جميع الحقول ورفع الصورة'); return; }

  const { data, error } = await supabase.storage
    .from('images')
    .upload(`ads/${currentUser.id}/${imageFile.name}`, imageFile);
  if (error) { alert(error.message); return; }
  const imageUrl = data.Key;

  await supabase.from('ads').insert([{
    user_id: currentUser.id,
    title, desc, category, image_url: imageUrl,
    created_at: new Date()
  }]);
  alert('تم نشر الإعلان');
  document.getElementById('adTitle').value='';
  document.getElementById('adDesc').value='';
  document.getElementById('adImage').value='';
  hideAdForm();
  loadUserAds();
}

// تحميل إعلانات المستخدم
async function loadUserAds() {
  const { data } = await supabase
    .from('ads')
    .select('*')
    .eq('user_id', currentUser.id);
  const container = document.getElementById('ad-list');
  container.innerHTML='';
  if (!data) return;
  data.forEach(ad => {
    const div = document.createElement('div');
    div.className='ad-item';
    const imageUrl = supabase.storage.from('images').getPublicUrl(ad.image_url).publicURL;
    div.innerHTML=`
      <h4>${ad.title}</h4>
      <img src="${imageUrl}" style="width:150px; border-radius:8px; margin-bottom:10px;" />
      <p>الفئة: ${ad.category}</p>
      <p>${ad.desc}</p>
      <button onclick="deleteAd('${ad.id}')">حذف</button>
      <button onclick="editAd('${ad.id}', '${ad.title}', '${ad.desc}', '${ad.category}', '${ad.image_url}')">تعديل</button>
    `;
    container.appendChild(div);
  });
}

// حذف إعلان
async function deleteAd(id) {
  await supabase.from('ads').delete().eq('id',id);
  loadUserAds();
}

// تحرير إعلان
function editAd(id, title, desc, category, imageUrl) {
  const newTitle=prompt('تعديل العنوان', title);
  const newDesc=prompt('تعديل الوصف', desc);
  const newCategory=prompt('تعديل الفئة', category);
  // رفع صورة جديدة إذا رغبت
  // يمكن تطويره لاحقًا
  if (newTitle && newDesc && newCategory) {
    supabase
    .from('ads')
    .update({ title: newTitle, desc: newDesc, category: newCategory })
    .eq('id', id)
    .then(() => loadUserAds());
  }
}

// الدردشة
let chatInterval;
async function loadMessages() {
  if (chatInterval) clearInterval(chatInterval);
  document.getElementById('messages').innerHTML='';
  chatInterval=setInterval(async ()=> {
    const { data }= await supabase
      .from('messages')
      .select('*')
      .order('created_at', { ascending:true });
    const container=document.getElementById('messages');
    container.innerHTML='';
    data.forEach(msg => {
      const msgDiv=document.createElement('div');
      msgDiv.className='message';
      msgDiv.innerHTML=`<strong>${msg.sender_name}:</strong> ${msg.message}`;
      container.appendChild(msgDiv);
    });
  }, 3000);
}
async function sendMessage() {
  const msg=document.getElementById('chatInput').value;
  if (!msg || !currentUser) return;
  await supabase.from('messages').insert([
    {
      sender_id: currentUser.id,
      sender_name: (await supabase.from('profiles').select('name').eq('id', currentUser.id).single()).data.name,
      message: msg,
      created_at: new Date()
    }
  ]);
  document.getElementById('chatInput').value='';
}

</script>
</body>
</html>
